<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 9 Climate Data Interpreter</title>
    
    <!-- 1. LINK CHART.JS LIBRARY -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 90%;
            max-width: 800px;
            background: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 20px;
        }
        h2 {
            color: #28a745;
            border-bottom: 2px solid #28a745;
            padding-bottom: 5px;
            margin-top: 25px;
        }
        .question-box {
            background-color: #eaf6ff;
            border: 1px solid #b8daff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .feedback-box {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            display: none;
            line-height: 1.4;
        }
        .correct {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .incorrect {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-top: 8px; /* Added for MC buttons */
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .mc-options button {
            background-color: #5bc0de;
            width: 100%;
            margin-bottom: 5px;
        }
        .mc-options button:hover {
            background-color: #31b0d5;
        }
        .score {
            text-align: right;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        .game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        /* Story Box Styles */
        .story-box {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }
        .story-box h2 {
            color: #856404;
            border-bottom: 2px solid #856404;
        }
        .story-box p {
            font-size: 1.1em;
            margin: 15px 0 25px 0;
        }
        .story-box button {
            background-color: #ffc107;
            color: #333;
            font-weight: bold;
        }
        .story-box button:hover {
            background-color: #e0a800;
        }

        /* --- ANIMATION STYLES --- */
        #animation-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s;
            z-index: 1000;
        }
        @keyframes data-burst {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        .animate { animation: data-burst 1s ease-out forwards; }
        
        /* Modal for Cheat Sheet */
        .modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover, .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .rule-list strong {
            color: #007bff;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üåç Climate Data Interpreter üìä</h1>
    <p>Practice reading climate graphs and applying classification rules!</p>
    <div class="score">Score: <span id="scoreValue">0</span></div>
    
    <!-- Rules Guide/Cheat Sheet Button -->
    <button onclick="openModal()" style="background-color: #f39c12; margin-bottom: 15px;">
        <span style="font-weight: bold;">?</span> Rules Guide
    </button>
    
    <!-- NEW ANIMATION ELEMENT -->
    <div id="animation-feedback">‚úÖ</div>

    <!-- The Game Content Goes Here -->
    <div class="game-area">
        
        <!-- Story/Break Container -->
        <div id="story-box" class="story-box">
            <h2 id="story-title"></h2>
            <p id="story-text"></p>
            <button id="story-button" onclick="handleStoryContinue()">Continue Mission</button>
        </div>
        
        <!-- Graph and Knowledge Questions -->
        <div id="graph-section" style="display: none;">
            <h2>Graph Interpretation Challenge</h2>
            <p>Analyze the climate data below to secure the first data set:</p>
            
            <!-- CANVAS ELEMENT FOR CHART.JS -->
            <div style="height: 350px; width: 100%; margin-bottom: 20px;">
                <canvas id="climateChart"></canvas>
            </div>
    
            <div id="graph-question" class="question-box">
                <p id="graph-q-text">Loading question...</p>
                <div id="mc-options-graph" class="mc-options">
                    <!-- Multiple choice buttons inserted here -->
                </div>
                <div id="graph-feedback" class="feedback-box"></div>
            </div>
        </div>


        <!-- Classification Challenge -->
        <div id="class-section" style="display: none;">
            <h2>Data Classification Station üèîÔ∏èüåä</h2>
            <p>Use the provided summary data to correctly classify the climate type:</p>
            <div id="class-question" class="question-box">
                <p id="class-q-text">Loading data...</p>
                <div id="mc-options-class" class="mc-options">
                    <button onclick="checkClassAnswer('Maritime')">Maritime üåä (Near Water)</button>
                    <button onclick="checkClassAnswer('Continental')">Continental üèîÔ∏è (Far Inland)</button>
                </div>
                <div id="class-feedback" class="feedback-box"></div>
            </div>
        </div>

        <div id="game-complete" class="story-box" style="display: none;">
            <h2>MISSION SUCCESSFUL! üéâ</h2>
            <p>You have secured all climate data! Your final score is <span id="finalScore" class="font-bold"></span>. You are officially a certified Climate Data Analyst.</p>
            <!-- REPLAY BUTTON ADDED -->
            <button onclick="resetGame()">Replay Mission üîÑ</button>
        </div>

    </div>
    <!-- End Game Content -->
</div>

<!-- Modal Structure (Cheat Sheet) -->
<div id="rulesModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2>Classification Rules Guide</h2>
        <p>Use these rules to categorize climates based on annual averages:</p>
        <ul class="rule-list" style="list-style-type: none; padding: 0;">
            <li><strong style="font-size: 1.1em;">üåä Maritime Climate (Near Water)</strong></li>
            <li style="margin-left: 20px;">üå°Ô∏è Annual Temperature Range is **moderate** (less than 25¬∞C).</li>
            <li style="margin-left: 20px;">üíß Total Annual Precipitation is **wet** (greater than 1000 mm).</li>
            <li style="margin-top: 15px;"><strong style="font-size: 1.1em;">üèîÔ∏è Continental Climate (Far Inland)</strong></li>
            <li style="margin-left: 20px;">üå°Ô∏è Annual Temperature Range is **Extreme** (greater than 25¬∞C).</li>
            <li style="margin-left: 20px;">üíß Total Annual Precipitation is **dry** (less than 1000 mm).</li>
        </ul>
    </div>
</div>

<script>
    let score = 0;
    const scoreElement = document.getElementById('scoreValue');
    let currentGraphQIndex = 0;
    let currentClassQIndex = 0;

    // --- DOM Elements ---
    const storyBox = document.getElementById('story-box');
    const graphSection = document.getElementById('graph-section');
    const classSection = document.getElementById('class-section');
    const gameComplete = document.getElementById('game-complete');
    const animationFeedback = document.getElementById('animation-feedback');
    const mcOptionsGraph = document.getElementById('mc-options-graph');
    const graphFeedback = document.getElementById('graph-feedback');
    const classFeedback = document.getElementById('class-feedback');
    
    // Global variable to hold the currently selected data
    let currentClimateData = {};

    // --- Game Data: Multiple Climate Profiles ---
    const CHART_MONTHS = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
    
    const CLIMATE_DATA_SETS = [
        {
            name: "Continental (Extreme/Dry)",
            temp: [-20, -22, -16, -10, -5, 2, 8, 9, 7, 0, -10, -18], // Max: 9, Min: -22. Range: 31 (Extreme)
            precip: [10, 8, 12, 16, 20, 25, 30, 40, 35, 28, 18, 12], // Total: 254 (Dry)
            questions: [
                {
                    q: "What month is the **Maximum Temperature** üå°Ô∏è (highest point on the red line)?",
                    a: "A", options: ["January (J)", "July (J)", "August (A)", "December (D)"],
                    concept: "The highest temperature is in **August** (A)."
                },
                {
                    q: "What is the approximate **Minimum Temperature** ü•∂ (lowest point on the red line)?",
                    a: "-22", options: ["0¬∞C", "-10¬∞C", "-15¬∞C", "-22¬∞C"],
                    concept: "The lowest temperature is **-22¬∞C** in February."
                },
                {
                    q: "What is the approximate **Maximum Rainfall** üíß value (highest blue bar)?",
                    a: "40", options: ["20 mm", "30 mm", "40 mm", "70 mm"],
                    concept: "The maximum rainfall is **40 mm** in August."
                }
            ]
        },
        {
            name: "Maritime (Moderate/Wet)",
            temp: [5, 4, 6, 9, 13, 16, 18, 17, 14, 11, 7, 5], // Max: 18, Min: 4. Range: 14 (Moderate)
            precip: [110, 95, 105, 80, 75, 50, 40, 55, 90, 120, 150, 130], // Total: 1200 (Wet)
            questions: [
                {
                    q: "What month is the **Maximum Temperature** üå°Ô∏è (highest point on the red line)?",
                    a: "J", options: ["January (J)", "June (J)", "July (J)", "December (D)"],
                    concept: "The highest temperature is in **July** (J), at 18¬∞C."
                },
                {
                    q: "What is the approximate **Minimum Temperature** ü•∂ (lowest point on the red line)?",
                    a: "4", options: ["0¬∞C", "4¬∞C", "8¬∞C", "-5¬∞C"],
                    concept: "The lowest temperature is **4¬∞C** in February."
                },
                {
                    q: "What is the approximate **Maximum Rainfall** üíß value (highest blue bar)?",
                    a: "150", options: ["100 mm", "120 mm", "150 mm", "200 mm"],
                    concept: "The maximum rainfall is **150 mm** in November."
                }
            ]
        }
    ];

    // Static questions (don't depend on the graph data)
    const STATIC_QUESTIONS = [
        { q: "The blue bars measure precipitation in what unit?", a: "mm", options: ["¬∞C", "Inches", "mm", "PPM"], concept: "The blue bars (Precipitation) are measured in **millimeters (mm)** on the left Y-axis." },
        { q: "Which describes a **short-term** state of the atmosphere?", a: "WEATHER", options: ["Climate", "Annual Range", "Weather", "Tropical"], concept: "Correct! **Weather** describes the atmosphere moment-to-moment or over short periods. Climate is the long-term pattern." },
        { q: "If the hottest month was 8¬∞C and the coldest was -5¬∞C, what is the Annual Temperature Range?", a: "13", options: ["3", "8", "13", "5"], concept: "The Annual Temperature Range is calculated as **8 - (-5) = 13**. (Formula Application)" }
    ];

    const ALL_CLASS_QUESTIONS = [
        { range: 12, precip: 1400, a: "Maritime", concept: "This is **Maritime üåä** because the Annual Temperature Range (12¬∞C) is **moderate** (< 25¬∞C) AND the Total Annual Precipitation (1400 mm) is **wet** (> 1000 mm)." },
        { range: 35, precip: 450, a: "Continental", concept: "This is **Continental üèîÔ∏è** because the Annual Temperature Range (35¬∞C) is **Extreme** (> 25¬∞C) AND the Total Annual Precipitation (450 mm) is **dry** (< 1000 mm)." },
        { range: 28, precip: 850, a: "Continental", concept: "The **Extreme** Annual Temperature Range (28¬∞C is > 25¬∞C) is the key indicator for a **Continental üèîÔ∏è** climate." },
        { range: 19, precip: 1100, a: "Maritime", concept: "The **Moderate** Annual Temperature Range (19¬∞C is < 25¬∞C) and **Wet** Annual Precipitation (1100 mm is > 1000 mm) classify this as a **Maritime üåä** climate." }
    ];
    
    const storyMoments = [
        {
            title: "üåç Mission Briefing: Climate Analyst",
            text: "Your goal is to save the Global Climate Data Archive! We've intercepted corrupted data, and you must analyze the core climate graphs and classify them correctly before the next storm hits. Your first task: **Graph Interpretation**.",
            button: "Start Graph Challenge üìä",
            nextAction: 'startGraph'
        },
        {
            title: "‚úÖ Data Set One Secured!",
            text: "Great work, Analyst! You correctly interpreted the visuals and secured the initial readings. Now, you must categorize the data using the **Classification Rules**. This is where you apply the formula! Remember: Maritime is **Moderate & Wet**, Continental is **Extreme & Dry**.",
            button: "Start Classification üõ∞Ô∏è",
            nextAction: 'startClass'
        }
    ];

    let graphQuestions = [];
    let classQuestions = [];

    // --- Core Reset Function ---
    function resetGame() {
        // Reset score and progress
        score = 0;
        scoreElement.textContent = score;
        currentGraphQIndex = 0;
        currentClassQIndex = 0;
        
        // 1. RANDOMIZE CLIMATE DATA SET
        const randomIndex = Math.floor(Math.random() * CLIMATE_DATA_SETS.length);
        currentClimateData = CLIMATE_DATA_SETS[randomIndex];

        // 2. BUILD THE GRAPH QUESTIONS ARRAY
        // Combine static questions with the graph-specific questions
        graphQuestions = [...currentClimateData.questions, ...STATIC_QUESTIONS];
        
        // 3. SHUFFLE BOTH QUESTION ARRAYS
        graphQuestions.sort(() => Math.random() - 0.5);
        classQuestions = [...ALL_CLASS_QUESTIONS];
        classQuestions.sort(() => Math.random() - 0.5);

        // Start the mission briefing
        showStoryBreak(0);
    }

    // --- Animation Function ---
    function triggerAnimation() {
        const emoji = (currentClassQIndex > 0 || currentGraphQIndex === graphQuestions.length) ? 'üíæ' : '‚úÖ';
        animationFeedback.textContent = emoji;
        animationFeedback.classList.add('animate');
        
        setTimeout(() => {
            animationFeedback.classList.remove('animate');
        }, 1000);
    }


    // --- Game Flow Control ---
    function showStoryBreak(index) {
        const moment = storyMoments[index];
        graphSection.style.display = 'none';
        classSection.style.display = 'none';
        gameComplete.style.display = 'none';
        storyBox.style.display = 'block';

        document.getElementById('story-title').textContent = moment.title;
        document.getElementById('story-text').innerHTML = moment.text;
        document.getElementById('story-button').textContent = moment.button;
        document.getElementById('story-button').onclick = () => handleStoryContinue(moment.nextAction);
    }
    
    function handleStoryContinue(action) {
        storyBox.style.display = 'none';
        if (action === 'startGraph') {
            graphSection.style.display = 'block';
            generateClimateChart();
            loadGraphQuestion();
        } else if (action === 'startClass') {
            classSection.style.display = 'block';
            loadClassQuestion();
        }
    }
    
    function showGameComplete() {
        graphSection.style.display = 'none';
        classSection.style.display = 'none';
        storyBox.style.display = 'none';
        gameComplete.style.display = 'block';
        document.getElementById('finalScore').textContent = score;
    }


    // --- Chart Generation (Now uses currentClimateData) ---
    function generateClimateChart() {
        if (typeof Chart === 'undefined') {
            console.error("Chart.js library not loaded.");
            return;
        }

        const ctx = document.getElementById('climateChart').getContext('2d');
        
        if (window.climateChartInstance) {
            window.climateChartInstance.destroy();
        }

        window.climateChartInstance = new Chart(ctx, {
            type: 'bar', 
            data: {
                labels: CHART_MONTHS,
                datasets: [
                    {
                        type: 'bar',
                        label: 'Rainfall üíß (mm)',
                        data: currentClimateData.precip, // Use selected data
                        backgroundColor: 'rgba(54, 162, 235, 0.6)', 
                        yAxisID: 'yRain',
                        order: 1 
                    },
                    {
                        type: 'line',
                        label: 'Temperature üå°Ô∏è (¬∞C)',
                        data: currentClimateData.temp, // Use selected data
                        borderColor: 'rgb(255, 99, 132)', 
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: false,
                        yAxisID: 'yTemp',
                        tension: 0.2, 
                        pointRadius: 5,
                        order: 0 
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        // Show the name of the climate type being analyzed
                        text: `Dynamic Climate Graph Analysis (${currentClimateData.name})`
                    },
                    legend: { display: true, position: 'top' }
                },
                scales: {
                    x: { title: { display: true, text: 'Month' } },
                    yRain: {
                        type: 'linear', position: 'left',
                        title: { display: true, text: 'Rainfall (mm)' },
                        min: 0, 
                        max: Math.max(...currentClimateData.precip, 70) * 1.1 // Adjust max rain based on data
                    },
                    yTemp: {
                        type: 'linear', position: 'right',
                        title: { display: true, text: 'Temperature (¬∞C)' },
                        min: Math.min(...currentClimateData.temp, -25) * 1.1, // Adjust min temp based on data
                        max: Math.max(...currentClimateData.temp, 10) * 1.1, // Adjust max temp based on data
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }


    // --- Game Logic: Multiple Choice Setup ---

    function loadGraphQuestion() {
        if (currentGraphQIndex >= graphQuestions.length) {
            showStoryBreak(1); 
            return;
        }
        const qData = graphQuestions[currentGraphQIndex];
        document.getElementById('graph-q-text').innerHTML = `**Question ${currentGraphQIndex + 1}:** ${qData.q}`;
        graphFeedback.style.display = 'none';

        // Clear and populate MC buttons
        mcOptionsGraph.innerHTML = '';
        
        qData.options.forEach(option => {
            const btn = document.createElement('button');
            btn.textContent = option;
            btn.onclick = () => checkGraphAnswer(option);
            mcOptionsGraph.appendChild(btn);
        });
    }

    function checkGraphAnswer(userSelection) {
        const qData = graphQuestions[currentGraphQIndex];
        
        let correctAnswer = qData.a.toUpperCase();
        let isCorrect = userSelection.toUpperCase().includes(correctAnswer);

        // Disable all buttons immediately after clicking
        mcOptionsGraph.querySelectorAll('button').forEach(btn => btn.disabled = true);

        if (isCorrect) {
            graphFeedback.innerHTML = `‚úÖ **Correct!** ${qData.concept}`;
            graphFeedback.className = 'feedback-box correct';
            score += 10; 
            scoreElement.textContent = score;
            
            triggerAnimation(); 

            currentGraphQIndex++;
            setTimeout(() => {
                mcOptionsGraph.querySelectorAll('button').forEach(btn => btn.disabled = false); // Re-enable for next q
                loadGraphQuestion();
            }, 1500); 
        } else {
            graphFeedback.innerHTML = `‚ùå **Incorrect.** The correct answer is **${qData.a}**. <br><br> **Rule Reminder:** ${qData.concept}`;
            graphFeedback.className = 'feedback-box incorrect';
            
            // Re-enable buttons after a short delay so user can try again on the same question
            setTimeout(() => { 
                mcOptionsGraph.querySelectorAll('button').forEach(btn => btn.disabled = false);
                graphFeedback.style.display = 'none'; 
            }, 2500); 
        }
        graphFeedback.style.display = 'block';
    }

    function loadClassQuestion() {
        if (currentClassQIndex >= classQuestions.length) {
            showGameComplete();
            return;
        }
        const qData = classQuestions[currentClassQIndex];
        document.getElementById('class-q-text').innerHTML = `**Classification Data ${currentClassQIndex + 1}:** <br> Annual Temperature Range: **${qData.range}¬∞C üå°Ô∏è** <br> Total Annual Precipitation: **${qData.precip} mm üíß**`;
        classFeedback.style.display = 'none';
        
        // Re-enable classification buttons
        document.getElementById('mc-options-class').querySelectorAll('button').forEach(btn => btn.disabled = false);
    }

    function checkClassAnswer(userAnswer) {
        const qData = classQuestions[currentClassQIndex];

        // Disable all buttons immediately after clicking
        document.getElementById('mc-options-class').querySelectorAll('button').forEach(btn => btn.disabled = true);

        if (userAnswer === qData.a) {
            classFeedback.innerHTML = `‚úÖ **Correct!** You categorized the data correctly. <br><br> **Classification Rule:** ${qData.concept}`;
            classFeedback.className = 'feedback-box correct';
            score += 20; 
            scoreElement.textContent = score;

            triggerAnimation(); 

            currentClassQIndex++;
            setTimeout(() => {
                loadClassQuestion();
            }, 1500); 
        } else {
            classFeedback.innerHTML = `‚ùå **Incorrect.** You chose ${userAnswer}. <br><br> **Classification Rule:** ${qData.concept}`;
            classFeedback.className = 'feedback-box incorrect';
            
            // Re-enable buttons after short delay
             setTimeout(() => { 
                document.getElementById('mc-options-class').querySelectorAll('button').forEach(btn => btn.disabled = false);
                classFeedback.style.display = 'none'; 
            }, 2500);
        }
        classFeedback.style.display = 'block';
    }
    
    // --- Modal Functions (Cheat Sheet) ---
    function openModal() {
        document.getElementById('rulesModal').style.display = 'block';
    }
    function closeModal() {
        document.getElementById('rulesModal').style.display = 'none';
    }
    // Close the modal if the user clicks anywhere outside of it
    window.onclick = function(event) {
        const modal = document.getElementById('rulesModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }


    // Initial loads
    window.onload = () => {
        // Run the reset function immediately to shuffle and start the game
        resetGame();
    };
</script>

</body>
</html>
